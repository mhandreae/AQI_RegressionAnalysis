---
title: "Import AQI data"
author: "Michael Andreae"
date: "Friday, June 19, 2015"
output: pdf_document
---

# Insurance status predicts antiemetic use 
We investigate the Hypothesis that insurance status predicets antiemetic use the population in the Public Use File of the Anestehsia Quality Institute with electronic anesthesia records recording antiemetic use.



```{r, packages, message=FALSE, echo=FALSE, warning=FALSE}
library(knitr) # required to set options in Markdown R
```



```{r, global_options, echo=FALSE}

# set the directory to the project directory
setwd("C:/Users/Micheal/Dropbox/Professional/AQI/AQI_RegressionAnalysis")

# set options
opts_chunk$set(fig.width=6, fig.height=4, fig.path='Figs/',
               echo=FALSE, warning=FALSE, message=FALSE)
```

# Data import

we load the original dataset and save as it as *PUF_Q4_2013.Rdata* 

## Original Data

```{r, eval=FALSE, echo=TRUE}
# run only once
PUF_Q4_2013 <- read.csv("Analysis/Data/PUF_Q4_2013_Antimetic.csv")
save(PUF_Q4_2013, file="Analysis/Data/PUF_Q4_2013.Rdata")
```

## Load Rdata AQI raw dataset *PUF_Q4_2013.Rdata* 

```{r, echo=TRUE}
rm(list = ls())
load("Analysis/Data/PUF_Q4_2013.Rdata")
```

# Clean Data

## Predictor: insurance status


```{r}
PUF_Q4_2013$Payment[PUF_Q4_2013$Payment == ""] <- NA
n_PaymentNA <-sum(is.na(PUF_Q4_2013$Payment))

PUF_Q4_2013 <- PUF_Q4_2013[complete.cases(PUF_Q4_2013$Payment),]

PUF_Q4_2013$Payment <- droplevels(PUF_Q4_2013$Payment)
levels(PUF_Q4_2013$Payment)[1] <- "Commercial"
```

The predictor insurance status (*Payment*) is coded in `r length(levels(PUF_Q4_2013$Payment))` levels as `r levels(PUF_Q4_2013$Payment)`, after we removed `r n_PaymentNA` cases without insurance information, (orginally coded as ""), with `r length(PUF_Q4_2013$Payment)` unique cases remaining.
(False indicating no NAs in Payment: `r anyNA(PUF_Q4_2013$Payment)`)

## Outcome variables: antiemetic administration

We focus on the antiemetics *ondansetron*, *dexamethason* and *droperidol*, the only agents with convincing evidence for effect. 

```{r}
### Ondansetron
PUF_Q4_2013$ondansetron <- 
  as.factor(PUF_Q4_2013$Antiemetics_ondansetron)
levels(PUF_Q4_2013$ondansetron) <- c("no Ondan", "Ondan")
```


```{r}
### Dexamethason
PUF_Q4_2013$dexamethason <- 
  as.factor(PUF_Q4_2013$Antiemetics_dexamethason)
levels(PUF_Q4_2013$dexamethason) <- c("no Dex", "Dex")
```


```{r}
### Droperidol
PUF_Q4_2013$droperidol <- 
  as.factor(PUF_Q4_2013$Antiemetics_droperidol)
levels(PUF_Q4_2013$droperidol) <- c("no Drope", "Drope")
```

```{r}
### Ondansetron or Dexamethason
PUF_Q4_2013$ondan_dex_either <- 
  as.factor((PUF_Q4_2013$Antiemetics_ondansetron == 1) | (PUF_Q4_2013$Antiemetics_dexamethason ==1))
levels(PUF_Q4_2013$ondan_dex_either) <- c("neither", "either")

kable(table(PUF_Q4_2013$ondansetron, 
            PUF_Q4_2013$dexamethason),
            caption = "Cases with Ondansetron versus Dexamethason")

kable(table(PUF_Q4_2013$ondansetron, 
            PUF_Q4_2013$droperidol),
            caption = "Cases with Ondansetron versus Droperidol")

kable(table(PUF_Q4_2013$dexamethason, 
            PUF_Q4_2013$droperidol),
            caption = "Cases with Dexamethason versus Droperidol")
```

The antiemetics *ondansetron* and *dexamethason* were sometimes administered together. This is coded in *ondan_dex_either*

## Potential confounders and other variables

### practice ID versus facility ID

```{r}
attach(PUF_Q4_2013)
kable(table(facilityID,practiceID))
```

The table of facility ID versus practice ID suggests that five practices have only one facility ID and one practice (=5013437) has three (sub) facilities. We will simplify by using practice ID, which has no NA.


### case_duration_minutes

```{r, echo=TRUE}
PUF_Q4_2013$case_duration_minutes [PUF_Q4_2013$case_duration_minutes == -1] <- NA
missing <- sum(PUF_Q4_2013$case_duration_minutes==-1)
PUF_Q4_2013 <- PUF_Q4_2013 [complete.cases(PUF_Q4_2013$case_duration_minutes),]
```

Case duration in minutes (*case_duration_minutes*) is an integer and has `r missing` missing values coded as -1, which we recoded as NA and removed from the dataset, leaving `r dim(PUF_Q4_2013)[1]` unique cases.

### patient age

```{r, echo=TRUE}
PUF_Q4_2013$patient_age[PUF_Q4_2013$patient_age==-1] <- NA
hist(PUF_Q4_2013$patient_age, 
     main = "Histogram of Age Distribution",
     xlab = "Age in years")
missing <- sum(patient_age==-1)
PUF_Q4_2013 <- PUF_Q4_2013[complete.cases(PUF_Q4_2013$patient_age),]
```

Patient age (*patient_age*) is an integer with a distribution above and has `r missing` missing values coded as -1, which we recoded as NA and removed from the dataset, leaving `r dim(PUF_Q4_2013)[1]` unique cases.

### patient_age_group

```{r, echo=TRUE}
levels(PUF_Q4_2013$patient_age_group)[2] <- "1-18"
levels(PUF_Q4_2013$patient_age_group)[1] <- NA
missing <- sum(is.na(PUF_Q4_2013$patient_age_group))
which(is.na(PUF_Q4_2013$patient_age_group))
PUF_Q4_2013 <- PUF_Q4_2013[complete.cases(PUF_Q4_2013$patient_age_group),]

```

Patient age group (*patient_age_group*) is a factor with `r length(levels(PUF_Q4_2013$patient_age_group))` levels: `r levels(PUF_Q4_2013$patient_age_group)`; it has `r missing` missing values, leaving `r dim(PUF_Q4_2013)[1]` unique cases.  

(Missing values were initially coded as -1, which we recoded as NA and removed as a level; we corrected the miscoding from "18-Jan"" to "1-18").

### patient_sex

```{r}
PUF_Q4_2013$patient_sex <- 
  as.factor(PUF_Q4_2013$patient_sex)

levels(PUF_Q4_2013$patient_sex)[1] <- NA
levels(PUF_Q4_2013$patient_sex)[1] <- "female"
levels(PUF_Q4_2013$patient_sex)[2] <- "male"
missing <- sum(is.na(PUF_Q4_2013$patient_sex))
PUF_Q4_2013 <- PUF_Q4_2013[complete.cases(PUF_Q4_2013$patient_sex),]
```

Patient gender (*patient_sex*) is recoded as factor with the two levels `r levels(PUF_Q4_2013$patient_sex)` and `r missing` NAs, which are removed from the dataset, leaving `r dim(PUF_Q4_2013)[1]` unique cases.

### in_or_out_patient

```{r}
PUF_Q4_2013$in_or_out_patient <- 
  as.factor(PUF_Q4_2013$in_or_out_patient)

levels(PUF_Q4_2013$in_or_out_patient)[1] <- NA
levels(PUF_Q4_2013$in_or_out_patient)[1] <- "Outpatient"
levels(PUF_Q4_2013$in_or_out_patient)[2] <- "Inpatient"
```


in- or outpatient status (*in_or_out_patient*) is recoded as a factor with the two levels `r levels(PUF_Q4_2013$in_or_out_patient)` and `r sum(is.na(PUF_Q4_2013$in_or_out_patient))` NAs, which are too numerous to include this variable in the dataset.

## surgical_cpt code

```{r}
# load("Analysis/Data/PUF_Q4_2013.Rdata")

PUF_Q4_2013$surgical_cpt <- 
  as.factor(PUF_Q4_2013$surgical_cpt)
levels(PUF_Q4_2013$surgical_cpt)[1] <- NA
missing <- sum(is.na(PUF_Q4_2013$surgical_cpt))
```

We considered to control with a random effect for *surgical_ctp* code but `r missing` NAs are too numerous.

# Save cleaned dataset
*AQI_4_14.Rdata* saved as a clean dataframe

```{r}

attach(PUF_Q4_2013)
myAQI_4_14 <- data.frame(Payment, 
                         ondansetron,
                         dexamethason,
                         droperidol,
                         ondan_dex_either,
                         practiceID=as.factor(practiceID), 
                         case_duration_minutes, 
                         patient_age, patient_age_group, 
                         patient_sex)

# all NA are already removed in the previous chunks
# myAQI_4_14 <- myAQI_4_14[complete.cases(myAQI_4_14),]

save (myAQI_4_14, file="Analysis/Data/myAQI_4_14.Rdata")
str(myAQI_4_14)
```
